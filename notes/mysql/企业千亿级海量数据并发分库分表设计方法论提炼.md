
# 企业千亿级海量数据并发分库分表设计方法论提炼.md

##  海量高并发数据- 主键设计选择

### 索引原理分析

* 聚簇索引
    -
    - 数据存储在主键索引中
    - 数据按主键顺序存储

* 二级索引
    -
    - 叶子中存储主键值
    - 一次查询需要走两遍索引
    - 主键大小会影响所有索引的大小
    
* 联合索引
    -
    - 某列使用范围查询，后面的列不能使用索引
    - 一个索引只能创建一棵树
    - 最左比配远侧
    - Key由多个字段组成
    
### 索引优化
* 存储空间
* 主键选择
    - 自增主键，顺序写入，效率高
    - 随机主键，节点页的分裂、数据移动（额外的磁盘IO）
    
* 联合索引
    - 按索引区分排序
    - 索引覆盖
    - 索引下推
    
* 字符串索引
    - 设置合理长度， 索引也是很占空间的
    - 不支持%开头的模糊查询
 
### 索引失效问题分析

* A=XX or B=XX 
mysql-5.1 后支持两个索引查
* 隐式类型转换
moblie='1234567';
moblie=1234567;
好习惯：每次在上线时，把测试环境的写好的sql，explian执行下，验证下是否索引生效

### 实践
* 数据库字符集使用utf8mb4  ，兼容表情
* varchar按实际需要分配长度
* 文本字段建议使用varchar
* 实践字段建议使用long，存放时间戳
* boll字段使用tinyint
* 枚举字段使用tinyint 
* 交易金额使用long
* 禁止使用“%” 前导的查询
* 禁止查询条件上运算
* 单张表索引数量不要超过五个
* 字符串索引使用前缀索引，前缀长度不超过10个字符
*

## 分表
* 垂直拆表
宽表 拆  两个表

* 水平拆分
    - 读写均匀
    - 冷热库拆分 
    
    
## 分库分表落地方案

### 用户库分表-案列

* 按照 userId 取模分128张表
思考： 需要按照手机号查询，怎么搞
解决：map映射表  手机号和userId ，就两个字段映射关系

### 商品库分表
使用pub字段 ，基因注入法

### 系统消息库分表
     - 时效性强
       一个表存两个月的数据，就能保证随时能查到最近30天的热数据
     - 冷热数据拆分
     
 
###  分表分少了怎么办？ 



## shardingshpere分库分表

### 带来的问题


* 分表分页查询
例如去取前10条，从各个表取10条，聚合后，再取前10条

* 分布式事务

   

    
    
    
    


